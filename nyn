#!/bin/bash
# NarayanaDB Main Command
# Usage: ./nyn [build|start|dev|stop|ui]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration
HTTP_PORT=${NARAYANA_HTTP_PORT:-8080}
UI_PORT=${NARAYANA_UI_PORT:-3000}
DATA_DIR=${NARAYANA_DATA_DIR:-./data}

# Print ASCII art banner
print_banner() {
    echo -e "${CYAN}"
    echo "███╗   ██╗ █████╗ ██████╗  █████╗ ██╗   ██╗ █████╗ ███╗   ██╗ █████╗ "
    echo "████╗  ██║██╔══██╗██╔══██╗██╔══██╗╚██╗ ██╔╝██╔══██╗████╗  ██║██╔══██╗"
    echo "██╔██╗ ██║███████║██████╔╝███████║ ╚████╔╝ ███████║██╔██╗ ██║███████║"
    echo "██║╚██╗██║██╔══██║██╔══██╗██╔══██║  ╚██╔╝  ██╔══██║██║╚██╗██║██╔══██║"
    echo "██║ ╚████║██║  ██║██║  ██║██║  ██║   ██║   ██║  ██║██║ ╚████║██║  ██║"
    echo "╚═╝  ╚═══╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═══╝╚═╝  ╚═╝"
    echo -e "${NC}"
    echo -e "${YELLOW}                    by Carlos Barbosa${NC}"
    echo ""
}

# Functions
info() {
    echo -e "${BLUE}[INFO]${NC}  $1"
}

success() {
    echo -e "${GREEN}[OK]${NC}  $1"
}

warning() {
    echo -e "${YELLOW}[WARN]${NC}  $1"
}

error() {
    echo -e "${RED}[ERROR]${NC}  $1"
    exit 1
}

# Check if port is in use
is_port_in_use() {
    local port=$1
    lsof -Pi :${port} -sTCP:LISTEN -t >/dev/null 2>&1
}

# Build the project
build() {
    info "Building NarayanaDB..."
    
    if ! command -v cargo &> /dev/null; then
        error "Rust/Cargo not found. Please install Rust: https://rustup.rs/"
    fi
    
    cd "${SCRIPT_DIR}"
    cargo build --release --bin narayana-server
    
    success "Build complete!"
    info "  Binary: ./target/release/narayana-server"
}

# Start server in background
start_server() {
    if is_port_in_use ${HTTP_PORT}; then
        warning "Port ${HTTP_PORT} is already in use"
        return 0
    fi

    info "Starting NarayanaDB server in background..."
    
    # Check if binary exists
    if [ ! -f "${SCRIPT_DIR}/target/release/narayana-server" ]; then
        error "Server binary not found. Run './nyn build' first"
    fi
    
    # Set environment variables
    export NARAYANA_ADMIN_USER=${NARAYANA_ADMIN_USER:-admin}
    export NARAYANA_ADMIN_PASSWORD=${NARAYANA_ADMIN_PASSWORD:-admin123}
    export NARAYANA_HTTP_PORT=${HTTP_PORT}
    export NARAYANA_DATA_DIR=${DATA_DIR}
    
    # Create data directory
    mkdir -p "${DATA_DIR}"
    
    # Start server
    cd "${SCRIPT_DIR}"
    nohup ./target/release/narayana-server > /tmp/narayana_server.log 2>&1 &
    SERVER_PID=$!
    echo $SERVER_PID > /tmp/narayana_server.pid
    
    # Wait for server to start
    info "Waiting for server to be ready..."
    for i in {1..30}; do
        if curl -s http://localhost:${HTTP_PORT}/health > /dev/null 2>&1; then
            success "Server started (PID: $SERVER_PID)"
            info "  HTTP API: http://localhost:${HTTP_PORT}"
            info "  Logs: tail -f /tmp/narayana_server.log"
            return 0
        fi
        sleep 1
    done
    
    error "Server failed to start. Check /tmp/narayana_server.log"
}

# Start server in foreground (dev mode)
dev_server() {
    if is_port_in_use ${HTTP_PORT}; then
        warning "Port ${HTTP_PORT} is already in use"
        info "Stopping existing server..."
        stop_all
        sleep 2
    fi

    info "Starting NarayanaDB server in foreground (dev mode)..."
    
    # Check if binary exists
    if [ ! -f "${SCRIPT_DIR}/target/release/narayana-server" ]; then
        error "Server binary not found. Run './nyn build' first"
    fi
    
    # Set environment variables
    export NARAYANA_ADMIN_USER=${NARAYANA_ADMIN_USER:-admin}
    export NARAYANA_ADMIN_PASSWORD=${NARAYANA_ADMIN_PASSWORD:-admin123}
    export NARAYANA_HTTP_PORT=${HTTP_PORT}
    export NARAYANA_DATA_DIR=${DATA_DIR}
    
    # Create data directory
    mkdir -p "${DATA_DIR}"
    
    # Start server in foreground
    cd "${SCRIPT_DIR}"
    ./target/release/narayana-server
}

# Stop server and UI
stop_all() {
    info "Stopping NarayanaDB server and UI..."
    
    # Stop server
    if [ -f /tmp/narayana_server.pid ]; then
        PID=$(cat /tmp/narayana_server.pid)
        if ps -p $PID > /dev/null 2>&1; then
            kill $PID 2>/dev/null || true
            sleep 2
            if ps -p $PID > /dev/null 2>&1; then
                kill -9 $PID 2>/dev/null || true
            fi
            success "Server stopped"
        fi
        rm -f /tmp/narayana_server.pid
    else
        pkill -f narayana-server || true
    fi
    
    # Stop UI
    if [ -f /tmp/narayana_ui.pid ]; then
        PID=$(cat /tmp/narayana_ui.pid)
        if ps -p $PID > /dev/null 2>&1; then
            kill $PID 2>/dev/null || true
            success "UI stopped"
        fi
        rm -f /tmp/narayana_ui.pid
    else
        # Try to find UI process
        pkill -f "vite.*narayana-ui" || true
        pkill -f "npm.*dev.*narayana-ui" || true
    fi
    
    # Clean up any remaining processes
    pkill -f "target/release/narayana-server" || true
    pkill -f "target/debug/narayana-server" || true
}

# Start UI
start_ui() {
    if is_port_in_use ${UI_PORT}; then
        warning "Port ${UI_PORT} is already in use (UI may already be running)"
    else
        info "Starting UI on port ${UI_PORT}..."
        
        # Check if UI directory exists
        if [ ! -d "${SCRIPT_DIR}/narayana-ui" ]; then
            error "UI directory not found: ${SCRIPT_DIR}/narayana-ui"
        fi
        
        # Install dependencies if needed
        if [ ! -d "${SCRIPT_DIR}/narayana-ui/node_modules" ]; then
            info "Installing UI dependencies..."
            cd "${SCRIPT_DIR}/narayana-ui"
            npm install
            cd "${SCRIPT_DIR}"
        fi
        
        # Start UI
        cd "${SCRIPT_DIR}/narayana-ui"
        nohup npm run dev > /tmp/narayana_ui.log 2>&1 &
        UI_PID=$!
        echo $UI_PID > /tmp/narayana_ui.pid
        cd "${SCRIPT_DIR}"
        
        # Wait for UI to start
        info "Waiting for UI to start..."
        sleep 5
        
        if is_port_in_use ${UI_PORT}; then
            success "UI started (PID: $UI_PID)"
            info "  UI: http://localhost:${UI_PORT}"
            info "  Logs: tail -f /tmp/narayana_ui.log"
        else
            warning "UI may not have started. Check /tmp/narayana_ui.log"
        fi
    fi
}

# Start both server and UI
start_ui_mode() {
    info "Starting NarayanaDB with UI..."
    
    # Start server first
    if ! is_port_in_use ${HTTP_PORT}; then
        start_server
        sleep 2
    fi
    
    # Start UI
    start_ui
    
    echo ""
    success "╔═══════════════════════════════════════════════════════════════╗"
    success "║     NARAYANADB IS RUNNING WITH UI!                            ║"
    success "║                                                               ║"
    success "║     Server: http://localhost:${HTTP_PORT}                        ║"
    success "║     UI:     http://localhost:${UI_PORT}                        ║"
    success "║                                                               ║"
    success "╚═══════════════════════════════════════════════════════════════╝"
    echo ""
    info "To stop: ./nyn stop"
}

# Load schema from schema.nyn
load_schema() {
    info "Loading schema from ./schema/schema.nyn..."
    
    if [ ! -d "./schema" ]; then
        error "Schema directory not found: ./schema"
    fi
    
    if [ ! -f "./schema/schema.nyn" ]; then
        error "Schema file not found: ./schema/schema.nyn"
    fi
    
    # Check if server is running
    if ! curl -s http://localhost:${HTTP_PORT}/health > /dev/null 2>&1; then
        error "Server is not running. Start it with './nyn start' first"
    fi
    
    response=$(curl -s -X POST http://localhost:${HTTP_PORT}/api/v1/schema/load)
    if echo "$response" | grep -q '"success":true'; then
        success "Schema loaded successfully"
        echo "$response" | grep -o '"message":"[^"]*"' | sed 's/"message":"\(.*\)"/\1/'
    else
        error "Failed to load schema: $response"
    fi
}

# Load seeds from seeds.nyn
load_seeds() {
    info "Loading seeds from ./schema/seeds.nyn..."
    
    if [ ! -d "./schema" ]; then
        error "Schema directory not found: ./schema"
    fi
    
    if [ ! -f "./schema/seeds.nyn" ]; then
        error "Seeds file not found: ./schema/seeds.nyn"
    fi
    
    # Check if server is running
    if ! curl -s http://localhost:${HTTP_PORT}/health > /dev/null 2>&1; then
        error "Server is not running. Start it with './nyn start' first"
    fi
    
    response=$(curl -s -X POST http://localhost:${HTTP_PORT}/api/v1/schema/seeds)
    if echo "$response" | grep -q '"success":true'; then
        success "Seeds loaded successfully"
        echo "$response" | grep -o '"message":"[^"]*"' | sed 's/"message":"\(.*\)"/\1/'
    else
        error "Failed to load seeds: $response"
    fi
}

# Spawn (load both schema and seeds)
spawn_schema() {
    info "Spawning schema and seeds..."
    
    if [ ! -d "./schema" ]; then
        error "Schema directory not found: ./schema"
    fi
    
    # Check if server is running
    if ! curl -s http://localhost:${HTTP_PORT}/health > /dev/null 2>&1; then
        error "Server is not running. Start it with './nyn start' first"
    fi
    
    response=$(curl -s -X POST http://localhost:${HTTP_PORT}/api/v1/schema/spawn)
    if echo "$response" | grep -q '"success":true'; then
        success "Schema and seeds spawned successfully"
        echo "$response" | grep -o '"message":"[^"]*"' | sed 's/"message":"\(.*\)"/\1/'
    else
        error "Failed to spawn schema/seeds: $response"
    fi
}

# Show usage
usage() {
    echo "Usage: ./nyn [command]"
    echo ""
    echo "Commands:"
    echo "  build   - Build the NarayanaDB server"
    echo "  start   - Start server in background"
    echo "  dev     - Start server in foreground (for development)"
    echo "  stop    - Stop server and UI"
    echo "  ui      - Start server and UI together"
    echo "  load    - Load database schema from ./schema/schema.nyn"
    echo "  seeds   - Load seed data from ./schema/seeds.nyn"
    echo "  spawn   - Load both schema and seeds"
    echo ""
    echo "Examples:"
    echo "  ./nyn build    # Build the server"
    echo "  ./nyn start    # Start server"
    echo "  ./nyn ui       # Start server + UI"
    echo "  ./nyn load     # Load schema"
    echo "  ./nyn seeds   # Load seeds"
    echo "  ./nyn spawn    # Load schema + seeds"
    echo "  ./nyn stop     # Stop everything"
}

# Main command handler
case "${1:-}" in
    build)
        print_banner
        build
        ;;
    start)
        print_banner
        start_server
        ;;
    dev)
        print_banner
        dev_server
        ;;
    stop)
        print_banner
        stop_all
        ;;
    ui)
        print_banner
        start_ui_mode
        ;;
    load)
        print_banner
        load_schema
        ;;
    seeds)
        print_banner
        load_seeds
        ;;
    spawn)
        print_banner
        spawn_schema
        ;;
    *)
        print_banner
        usage
        exit 1
        ;;
esac

